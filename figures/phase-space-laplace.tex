\usetikzlibrary{math, 3d, calligraphy}

% --- styles ---

\definecolor{pwbeige}{RGB}{172, 146, 122}
\definecolor{pworange}{RGB}{245, 153, 30}

\tikzset{
  surf/.style={pwbeige!10},
  leaf/.style={thin, pwbeige!60},
  sing/.style={thick, pworange},
  ray/.style={thick}
}

% --- cotangent fibers ---

\newcommand{\rfiber}{1.5}

\newcommand{\drawfiber}{
  \calligraphy[copperplate, light, thin] (0, -\rfiber) -- (0, -4.5);
  \foreach \sgn in {-1, 1} {
    \calligraphy[scale=\sgn, copperplate, heavy, heavy line width=0.25mm]
      (\rfiber, \rfiber) -- (\rfiber, -\rfiber)
      (\rfiber, -\rfiber) -- (-\rfiber, -\rfiber);
  };
}

\newenvironment{fiber}{%
  \begin{scope}
    \fill[surf] (-\rfiber, -\rfiber) rectangle (\rfiber, \rfiber);
    \clip (-\rfiber, -\rfiber) rectangle (\rfiber, \rfiber);
}{% ...
  \end{scope}
  \drawfiber
}

\newcommand{\genfibercontent}{
  \pgfmathsetmacro{\hatch}{\rfiber/8};
  \pgfmathsetmacro{\firsthatch}{-\rfiber+\hatch}
  \pgfmathsetmacro{\nexthatch}{-\rfiber+2*\hatch}
  \pgfmathsetmacro{\hatchstop}{\rfiber-\hatch/2}
  \foreach \y in {\firsthatch, \nexthatch, ..., \hatchstop} {
    \draw[leaf] (-\rfiber, \y) -- (\rfiber, \y);
  };
  \fill circle (\dotsize);
}

\newcommand{\singfibercontent}{
  % nonsingular leaves
  \foreach \sector in {0, 60, 120, 180, 240, 300} {
    \tikzmath{
      \farout = 45*floor((\sector + 59) / 45);
      \tfarout = 3*(\farout - \sector);
      \rfarout = \rfiber/sin(45+mod(\farout-45, 90));
    }
    \draw[green] (0, 0) -- (\farout:\rfarout);
    \pgfmathsetmacro{\rmax}{sin(\tfarout) * pow(\rfarout, 3)}
    \foreach \r in {0.5, 1.0, ..., \rmax} {
      \pgfmathsetmacro{\win}{asin(\r/(2*\rmax))}
      \draw[leaf, rotate=\sector, domain=\win:{180-\win}, variable=\t] plot ({\t/3}:{(\r/sin(\t))^(1/3)});
    };
    
    % singular leaves
    \foreach \ang in {0, 120, 240} {
      \draw[sing] (\ang:{-sqrt(2)*\rfiber}) -- (\ang:{sqrt(2)*\rfiber});
    };
    \fill[sing] circle (\dotsize);
  };
}

% --- posititon plane ---

\pgfmathsetmacro{\hatch}{2/3}
\tikzmath{
  \dotsize = 0.04;
  \xsing = 2;
  \zsing = 4*\hatch;
  \xgen = 6;
  \zgen = 8*\hatch;
  \rcut = 1/5;
}

\newcommand{\phaseSpaceLaplace}{
\begin{tikzpicture}[z={(0.25cm, 0.2cm)}]
% position plane
\begin{scope}[canvas is xz plane at y=0]
  % surface
  \fill[surf]
    (0, 0) -- (0, \zsing-\rcut)
    -- ++(\xsing-\rcut, 0) arc (-90:90:\rcut) -- (0, {\zsing + \rcut})
    -- (0, 8) --(8, 8) -- (8, 0) -- cycle;
  
  % hatching
  \pgfmathsetmacro{\nexthatch}{2*\hatch}
  \pgfmathsetmacro{\singstop}{\zsing - \hatch/2}
  \foreach \z in {\hatch, \nexthatch, ..., \singstop} {
    \draw[leaf] (0, \z) -- (8, \z);
  };
  \pgfmathsetmacro{\singstart}{\zsing + \hatch}
  \pgfmathsetmacro{\singnext}{\zsing + 2*\hatch}
  \pgfmathsetmacro{\hatchstop}{8 - \hatch/2}
  \foreach \z in {\singstart, \singnext, ..., \hatchstop} {
    \draw[leaf] (0, \z) -- (8, \z);
  };
  
  % singular leaves
  \begin{scope}[sing]
    \draw (\xsing, \zsing) -- (8, \zsing);
    \draw (0, \zsing-\rcut) -- ++(\xsing-\rcut, 0) arc (-90:90:\rcut) -- (0, {\zsing + \rcut});
  \end{scope}
  
  % generic ray
  \draw[ray] (\xgen, \zgen) -- (8, \zgen);
  
  % outline
  \calligraphy[copperplate, heavy, heavy line width=0.25mm]
    (0, 0) -- (0, \zsing-\rcut)
    (0, \zsing+\rcut) -- (0, 8)
    (0, 8) -- (8, 8)
    (8, 8) -- (8, 0)
    (8, 0) -- (0, 0);
\end{scope}

% generic fiber
\begin{scope}[canvas is xy plane at z=\zgen, shift={(\xgen, 4.5)}]
  \begin{fiber}
    \genfibercontent
  \end{fiber}
\end{scope}

% singular fiber
\begin{scope}[canvas is xy plane at z=\zsing, shift={(\xsing, 4.5)}]
  \begin{fiber}
    %%\singfibercontent
  \end{fiber}
  \singfibercontent
\end{scope}

% generic point
\fill (\xgen, 0, \zgen) circle (\dotsize);

% singular point
\fill[sing] (\xsing, 0, \zsing) circle (\dotsize);
\end{tikzpicture}
}
